# Comprehensive Validated Project Understanding

**Project:** Morning Brew Collective
**Date:** Wednesday, January 21, 2026
**Validator:** Gemini CLI Agent
**Status:** Phase 5 (Payment Integration) Complete, Verification In Progress

---

## 1. Executive Summary

Morning Brew Collective is a Singapore-first headless commerce platform digitalizing a heritage 1970s kopitiam. It adheres to a "Retro-Futuristic" aesthetic and strict Singaporean compliance mandates (GST, PDPA, PayNow).

**Core Philosophy:**
*   **Anti-Generic:** Rejection of standard UI templates. Custom "retro-*" component wrappers enforce a specific 70s aesthetic.
*   **BFF Architecture:** Next.js (Frontend) handles UX/UI ("Soul"), Laravel (Backend) handles Data/Logic ("Truth").
*   **Compliance First:** All financial data uses `DECIMAL(10,4)` to ensure 9% GST precision without rounding errors.

**Current State:**
*   **Backend:** Phase 5 complete. Services (Payment, Stripe, PayNow) active. Schema compliant.
*   **Frontend:** Phase 5 UI implemented. Payment components ready. Critical Type/Logic discrepancies identified.
*   **Infrastructure:** Dockerized (Postgres 16, Redis 7, PHP 8.3, Node 22).

---

## 2. Validated Architecture & Tech Stack

### Frontend (`/frontend`)
*   **Framework:** Next.js 15 (App Router), React 19, TypeScript 5.4.
*   **Styling:** Tailwind CSS 4.0 with `tokens.css` (Design Tokens).
*   **Components:**
    *   **UI Primitives:** `src/components/ui/retro-*.tsx` (Wrappers around Radix/Shadcn).
    *   **Payment UI:** `src/components/payment/` (8 components including `stripe-payment-form`, `paynow-qr-display`).
*   **State Management:** Zustand (`cart-store.ts`, `payment-store.ts`).
*   **Math Logic:** `src/lib/decimal-utils.ts` (Handles `x10000` scaling for precision).

### Backend (`/backend`)
*   **Framework:** Laravel 12 (API-First).
*   **Database:** PostgreSQL 16.
*   **Key Services:**
    *   `PaymentService`: Orchestrator.
    *   `StripeService` & `PayNowService`: Provider adapters.
    *   `InventoryService`: Two-phase reservation (Redis + DB).
    *   `PdpaService`: Consent logging.
*   **Schema Compliance:**
    *   `orders` table: `subtotal`, `gst_amount`, `total_amount` are `DECIMAL(10,4)`. **NO** integer cents columns.
    *   `payments` table: `amount` is `DECIMAL(10,4)`.

### Infrastructure
*   **Docker:** Full stack running (Postgres, Redis, Backend, Frontend, Mailpit).
*   **Workflow:** `Makefile` standardizes `make up`, `make test`, `make migrate`.

---

## 3. Validation Findings & Discrepancies

### âœ… Validated Successes
1.  **Backend Compliance:** Database migration `2026_01_17_000004_create_orders_table.php` correctly uses `decimal(10,4)` for all financial fields.
2.  **Frontend Math Utilities:** `src/lib/decimal-utils.ts` correctly implements scaling factor `10000` for precision arithmetic.
3.  **Component Architecture:** `retro-*` components exist and are used, preventing "generic UI drift."

### ðŸ”´ Critical Discrepancies (Action Required)

#### 1. Frontend Type Definitions Mismatch (`api.ts`)
*   **Observation:** `frontend/src/types/api.ts` defines `Order` with `subtotal_cents`, `gst_cents`, `total_cents` as `number`.
*   **Reality:** The Backend `Order` API returns `subtotal`, `gst_amount`, `total_amount` (decimals). It does **NOT** return cents.
*   **Risk:** Frontend components relying on `api.ts` types to read backend responses will fail (reading `undefined` values), causing UI crashes or "S$0.00" displays.

#### 2. Fragile GST Calculation in UI
*   **Observation:** `payment-success.tsx` and `checkout/confirmation/page.tsx` calculate GST locally using `amount * 0.09`.
*   **Reality:**
    *   Backend calculates GST as `round(subtotal * 0.09, 4)`.
    *   Frontend UI calculates `Total * 0.09` (which implies tax-exclusive logic on a tax-inclusive total) or simply naÃ¯ve math.
    *   `payment-success.tsx` logic: `const gst = amount * 0.09; const subtotal = amount - gst;`. This is mathematically incorrect for Singapore GST (Inclusive). Correct is `GST = Total * (9/109)`.
*   **Risk:** Displayed GST breakdown will not match the official Tax Invoice generated by backend.
*   **Action:** UI should **display values from the Backend Response** (`order.gst_amount`), NOT recalculate them locally.

#### 3. Backend Model Casting Inconsistency
*   **Observation:** `backend/app/Models/Payment.php` casts `amount` to `decimal:2`.
*   **Reality:** Database stores `decimal(10,4)`.
*   **Risk:** Potential precision loss when accessing `Payment` models in PHP before processing. Should be `decimal:4`.

---

## 4. Development Roadmap

### Priority 1: Fix Frontend Data Contract (Immediate)
1.  **Update `frontend/src/types/api.ts`:**
    *   Remove `_cents` fields from `Order`, `OrderItem`.
    *   Add `subtotal`, `gst_amount`, `total_amount` as `number`.
    *   Update `unit_price` in `OrderItem`.
2.  **Refactor Frontend Display Logic:**
    *   Update `payment-success.tsx` and `order-summary.tsx` to read values directly from the `Order` object (fetched from API) rather than recalculating them.
    *   Use `decimal-utils` for any necessary client-side formatting.

### Priority 2: Backend Polish
1.  **Update Payment Model:** Change `$casts` in `Payment.php` to `'amount' => 'decimal:4'`.
2.  **Verify API Resources:** Ensure `OrderResource` (if used) or `OrderController` explicitly returns the decimal fields in the JSON response.

### Priority 3: Testing & Hardening
1.  **E2E Tests:** Add a test case that creates an order with a fractional GST amount (e.g., 1 item at $1.50) and verifies the confirmation page displays the exact GST value stored in DB.

---

## 5. Agent Guidelines
*   **Type Safety:** Always check `api.ts` against actual Backend API responses (via `make shell-backend` -> `tinker` or `curl`).
*   **Math:** NEVER use `* 0.09` in frontend code. Use `decimal-utils` or rely on backend values.
*   **UI:** Continue using `retro-*` components. Do not import Shadcn primitives directly.
