name: Deploy to Staging

on:
  push:
    branches: [develop]

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          echo "Host staging.example.com" > ~/.ssh/config
          echo "  IdentityFile ~/.ssh/staging_key" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy Frontend
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          echo "Deploying frontend to staging..."
          cd frontend && npm run build
          rsync -avz -e "ssh -i ~/.ssh/staging_key" --delete ./build/ ${STAGING_USER}@${STAGING_HOST}:/var/www/staging-frontend/

      - name: Deploy Backend
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          echo "Deploying backend to staging..."
          cd backend && composer install --no-dev --optimize-autoloader
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          rsync -avz -e "ssh -i ~/.ssh/staging_key" --exclude-from='deploy-exclude.txt' ./ ${STAGING_USER}@${STAGING_HOST}:/var/www/staging-backend/

      - name: Clear Caches
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
        run: |
          ssh -i ~/.ssh/staging_key ${STAGING_USER}@${STAGING_HOST} "cd /var/www/staging-backend && php artisan cache:clear && php artisan config:clear"
